@prefix era: <http://data.europa.eu/949/> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .


# SPT2TS-130923: All FoulingPoints associated with a Crossing shall be positioned on the same LinearElements referenced in the Crossing's topologicalCoordinates.
# ===== Crossing FoulingPoint LinearElement Constraint =====
era:CrossingFoulingPointLinearElementShape a sh:NodeShape ;
    sh:targetClass era:Crossing ;
    
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "All FoulingPoints associated with a Crossing must be positioned on LinearElements that are also referenced in the Crossing's topologicalCoordinates." ;
        sh:select """
            PREFIX era: <http://data.europa.eu/949/>
            
            SELECT $this ?foulingPoint ?fpLinearElement
            WHERE {
                $this era:foulingPoints ?foulingPoint .
                ?foulingPoint era:topologicalCoordinate ?fpTC .
                ?fpTC era:onLinearElement ?fpLinearElement .
                
                FILTER NOT EXISTS {
                    $this era:topologicalCoordinates ?crossingTC .
                    ?crossingTC era:onLinearElement ?fpLinearElement .
                }
            }
        """ ;
        sh:severity sh:Violation ;
    ] .
	
	
# SPT2TS-125958: The position (pos) of every kilometric post in a LinearElementKm shall not exceed the length of the corresponding LinearElement.
# ===== KilometricPost Position Within LinearElement Length Constraint =====
era:KilometricPostPositionWithinLengthShape a sh:NodeShape ;
    sh:targetClass era:LinearElementKm ;
    
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "The position (pos) of every KilometricPost in a LinearElementKm must not exceed the length (lengthOfNetLinearElement) of the corresponding LinearElement." ;
        sh:select """
            PREFIX era: <http://data.europa.eu/949/>
            PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
            
            SELECT $this ?kilometricPost ?position ?elementLength
            WHERE {
                $this era:linearElement ?linearElement .
                ?linearElement era:lengthOfNetLinearElement ?elementLength .
                
                $this era:kilometricPosts ?kpList .
                ?kpList rdf:rest*/rdf:first ?kilometricPost .
                ?kilometricPost era:pos ?position .
                
                FILTER (?position > ?elementLength)
            }
        """ ;
        sh:severity sh:Violation ;
    ] .
	

	
# SPT2TS-130878: For every Level Crossings, the danger points shall be congruent with the corresponding areaReference
era:LevelCrossingDangerPointCoverageConstraint
    a sh:NodeShape ;
    sh:targetClass era:LevelCrossing ;

    sh:sparql [
        sh:message """
        Each DangerPoint must lie on a LinearElement segment that is fully
        covered by the LevelCrossing's areaReference. The offsetFromOrigin
        must fall within the start -> end bounds of a matching NetLinearReference.
        """ ;
        sh:severity sh:Violation ;

        sh:select """
        PREFIX era: <http://data.europa.eu/949/>
        PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>

        SELECT ?this ?dp ?linearElement ?dpOffset
        WHERE {
            #####################################################
            # 1. LC -> DangerPoints -> TopologicalCoordinate -> LE + offset
            #####################################################
            ?this era:dangerPoints ?dp ;
                  era:areaReference ?ar .

            ?dp era:topologicalCoordinate ?tc .
            ?tc era:onLinearElement ?linearElement .
            ?tc era:offsetFromOrigin ?dpOffset .

            #####################################################
            # 2. Expand areaReference.includes rdf:List -> ?lr
            #####################################################
            ?ar era:includes ?incList .
            ?incList rdf:rest*/rdf:first ?lr .

            #####################################################
            # 3. Extract start/end coordinates + offsets
            #####################################################
            ?lr era:startsAt ?startTC .
            ?startTC era:onLinearElement ?startLE .
            ?startTC era:offsetFromOrigin ?startOffset .

            ?lr era:endsAt ?endTC .
            ?endTC era:onLinearElement ?endLE .
            ?endTC era:offsetFromOrigin ?endOffset .

            #####################################################
            # 4. Coverage conditions (4 cases)
            #####################################################

            FILTER NOT EXISTS {

                # CASE 1 — DP on SAME LE between start and end
                {
                    FILTER(?linearElement = ?startLE && ?linearElement = ?endLE)
                    FILTER(?dpOffset >= ?startOffset && ?dpOffset <= ?endOffset)
                }

                UNION

                # CASE 2 — DP on START element only (multi-element path)
                {
                    FILTER(?linearElement = ?startLE && ?startLE != ?endLE)
                    FILTER(?dpOffset >= ?startOffset)
                }

                UNION

                # CASE 3 — DP on END element only
                {
                    FILTER(?linearElement = ?endLE && ?startLE != ?endLE)
                    FILTER(?dpOffset <= ?endOffset)
                }

                UNION

                # CASE 4 — DP on intermediate element via hasSequence
                {
                    ?lr era:hasSequence ?seqList .
                    ?seqList rdf:rest*/rdf:first ?linearElement .
                }
            }
        }
        """ ;
    ] .

	
	
# SPT2TS-130910: All FoulingPoints associated with a Switch shall be positioned on LinearElements that are directly connected via the Switch's leftBranch or rightBranch NetRelations.
# ===== Switch FoulingPoint LinearElement Constraint =====
era:SwitchFoulingPointLinearElementShape a sh:NodeShape ;
    sh:targetClass era:Switch ;
    
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "All FoulingPoints associated with a Switch must be positioned on LinearElements that are directly connected via the Switch's leftBranch or rightBranch NetRelations (i.e., on elementA or elementB of these NetRelations)." ;
        sh:select """
            PREFIX era: <http://data.europa.eu/949/>
            
            SELECT $this ?foulingPoint ?fpLinearElement
            WHERE {
                $this era:foulingPoints ?foulingPoint .
                ?foulingPoint era:topologicalCoordinate ?fpTC .
                ?fpTC era:onLinearElement ?fpLinearElement .
                
                # Check if this LinearElement is NOT connected via leftBranch or rightBranch
                FILTER NOT EXISTS {
                    {
                        $this era:leftBranch ?leftBranchNR .
                        {
                            ?leftBranchNR era:elementA ?fpLinearElement .
                        }
                        UNION
                        {
                            ?leftBranchNR era:elementB ?fpLinearElement .
                        }
                    }
                    UNION
                    {
                        $this era:rightBranch ?rightBranchNR .
                        {
                            ?rightBranchNR era:elementA ?fpLinearElement .
                        }
                        UNION
                        {
                            ?rightBranchNR era:elementB ?fpLinearElement .
                        }
                    }
                }
            }
        """ ;
        sh:severity sh:Violation ;
    ] .